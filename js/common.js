// Translations object
const translations = {
  no: {
    devBanner: '<i class="fa-solid fa-triangle-exclamation"></i> Denne nettsiden er under utvikling',
    skipToContent: "Hopp til innhold",
    projects: "Prosjekter",
    experience: "Erfaring",
    skills: "Ferdigheter",
    about: "Om meg",
    contact: "Kontakt",
    degreeProgram: "Automatisering og intelligente systemer @ NTNU · Trondheim",
    greeting: "Hei, jeg er",
    heroSubtitle:
      "Bachelorstudent i Automatisering og intelligente systemer ved NTNU, med spesialisering innen robotikk, autonomi og reguleringsteknikk. Erfaring med simulering og utvikling av styringssystemer, samt ledererfaring som skiftleder i et dynamisk arbeidsmiljø.",
    seeProjects: "Se prosjekter",
    getInTouch: "Ta kontakt",
    controlSystems: "Reguleringsteknikk",
    modeling: "Modellering",
    physics: "Fysikk",
    openToInternships: "Åpen for sommerjobb · 2026",
    heroDescription:
      "Nysgjerrig automatiseringsstudent med lidenskap for autonomi, navigasjon og regulering. Søker sommerjobb der jeg kan bidra til å utvikle robuste, intelligente systemer, og lære av ekte ingeniørutfordringer underveis.",
    downloadCV: "Last ned CV",
    emailMe: "Send meg en e-post",
    featuredProjects: "Utvalgte prosjekter",
    projectsSubtitle: "Noen ting jeg har gjort nylig.",
    repo: "Repo",
    financialManager: "Økonomisjef",
    voluntaryWork: "Frivillig arbeid",
    present: "Nåværende",
    financialManagerDesc:
      "Hadde ansvar for budsjettering, regnskap og finansiell planlegging for linjeforeningen for elektrostudenter ved NTNU. Innførte strukturerte rutiner som forbedret transparens, nøyaktighet og kontroll over organisasjonens økonomi.",
    shiftLeader: "Skiftleder",
    partTime: "Deltid",
    shiftLeaderDesc:
      "Ansvarlig for opplæring, drift og kundeservice i et tempofylt miljø. Bidro til forbedrede prosedyrer som økte effektiviteten i billett- og kiosksalg samtidig som kundeopplevelsen ble bedre.",
    teachingAssistant: "Læringsassistent",
    teachingAssistantDesc:
      "Støtter undervisning og veiledning av studenter ved NTNU. Gir faglig hjelp, assisterer med øvinger og bidrar til dypere forståelse av pensum.",
    communicationsOperator: "Sambandsoperatør - Luftvern",
    fullTime: "Heltid",
    norwegianArmedForces: "Forsvaret",
    communicationsOperatorDesc:
      "Operativ erfaring med sambandssystemer i Luftvernbataljonen. Tjenestegjorde som del av NATOs reaksjonsstyrke, noe som krevde presisjon, samarbeid og beredskap. Bidro til sikker og effektiv kommunikasjon under krevende forhold.",
    bartender: "Bartender",
    bartenderDesc:
      "Jobbet under UKA studentfestival på Samfundet i Trondheim, en av Norges største studentfestivaler. Arbeidet i et hektisk barmiljø og utviklet sterke ferdigheter innen service, samarbeid og stressmestring under krevende forhold.",
    managerAndTreasurer: "Leder og kasserer",
    managerAndTreasurerDesc:
      "Ledet en årlig skolerevue ved Thora Storm videregående skole med over 150 deltakere. Ansvarlig for planlegging, øvinger og gjennomføring av produksjonen, samt budsjettering og økonomistyring, inkludert billettsalg og sponsorer.",
    programming: "Programmering",
    unitTesting: "Enhetstesting",
    controlsAndSignals: "Regulering og signaler",
    rootLocus: "Rotkurve",
    hardware: "Maskinvare",
    aboutText1:
      "Bachelorstudent i Automatisering og intelligente systemer ved NTNU, med interesse for robotikk, autonomi og reguleringsteknikk. Jeg har erfaring med simulering og utvikling av styringssystemer, og har samtidig opparbeidet meg god ledererfaring som skiftleder i et dynamisk arbeidsmiljø. På fritiden engasjerer jeg meg i studentfrivilligheten og trives godt i sosiale settinger. Jeg liker også å utforske egne prosjekter, blant annet innen smarthus og home-lab, små kodeprosjekter, 3D-printing og programmering av mikrokontrollere som ESP-familien.",
    highlights: "Høydepunkter",
    highlight1:
      "Praktisk erfaring med sensorer (IMU, ToF, enkodere) og sanntidskrav.",
    highlight2: "Komfortabel med å gå fra simulering til maskinvare.",
    highlight3: "Nysgjerrig, pålitelig og sikkerhetsbevisst.",
    letsStartSomething: "La oss starte noe bra",
    contactDesc:
      "Send meg en e-post direkte eller bruk skjemaet. Jeg er åpen for sommerjobb, prosjekter og samarbeid.",
    name: "Navn",
    email: "E-post",
    message: "Melding",
    formNote:
      "Dette skjemaet åpner e-postprogrammet ditt med en forhåndsutfylt melding.",
    send: "Send",
    login: "Logg inn",
    logout: "Logg ut",
    admin: "Admin",
    dashboard: "Dashboard",
    loginTitle: "Admin login",
    loginSubtitle: "Logg inn til dashboard",
    emailLabel: "E-postadresse",
    passwordLabel: "Passord",
    loginButton: "Logg inn",
    errorMessage: "Ugyldig e-postadresse eller passord",
    notAnders: "Er du ikke Anders?",
    requestAccess: "Be om tilgang",
    backToHome: '<i class="fa-solid fa-arrow-left"></i> Tilbake til forsiden',
    meta: {
      description:
        "Portfolio og kontaktside for student i Automatisering og intelligente systemer (NTNU). Prosjekter, erfaring og måter å ta kontakt på.",
      title: "Anders Garberg — Automatisering og intelligente systemer",
    },
    placeholders: {
      name: "Ditt navn",
      email: "deg@domene.no",
      message: "Fortell meg om deg selv",
    },
    cv: "content/CV_no.pdf",
  },
  en: {
    devBanner: '<i class="fa-solid fa-triangle-exclamation"></i> This website is under development',
    skipToContent: "Skip to content",
    projects: "Projects",
    experience: "Experience",
    skills: "Skills",
    about: "About",
    contact: "Contact",
    degreeProgram: "Automation & Intelligent Systems @ NTNU · Trondheim",
    greeting: "Hi, I'm",
    heroSubtitle:
      "Bachelor's student in Automation and Intelligent Systems at NTNU, specializing in robotics, autonomy, and control engineering. Skilled in simulation and control system development, complemented by leadership experience as a shift supervisor in a dynamic work environment.",
    seeProjects: "See projects",
    getInTouch: "Get in touch",
    controlSystems: "Control systems",
    modeling: "Modeling",
    physics: "Physics",
    openToInternships: "Open to Internships · 2026",
    heroDescription:
      "Curious automation student passionate about autonomy, navigation, and control. Looking for a summer internship where I can contribute to developing resilient, intelligent systems, and learn from real engineering challenges along the way.",
    downloadCV: "Download CV",
    emailMe: "Email me",
    featuredProjects: "Featured Projects",
    projectsSubtitle: "A few things I've done recently.",
    Lorem: "Lorem",
    "Lorem, ipsum.": "Lorem, ipsum.",
    "Lorem ipsum dolor sit amet.": "Lorem ipsum dolor sit amet.",
    repo: "Repo",
    financialManager: "Financial Manager",
    voluntaryWork: "Voluntary work",
    present: "Present",
    financialManagerDesc:
      "Oversaw the budgeting, accounting, and financial planning processes for the student organization representing electrical engineering students at NTNU. Introduced structured financial management procedures that enhanced transparency, accuracy, and control of the organization's financial operations.",
    shiftLeader: "Shift Leader",
    partTime: "Part-time",
    shiftLeaderDesc:
      "Responsible for training, operations, and customer service in a fast-paced environment. Contributed to improved procedures that increased efficiency in ticketing and concession operations while enhancing the overall customer experience.",
    teachingAssistant: "Teaching Assistant",
    teachingAssistantDesc:
      "Supports teaching and student guidance at NTNU. Provides academic assistance, helps with exercises, and facilitates deeper understanding of the course material.",
    communicationsOperator: "Communications Operator - Air Defence",
    fullTime: "Full-time",
    norwegianArmedForces: "Norwegian Armed Forces",
    communicationsOperatorDesc:
      "Operational experience with communication systems in the Air Defence Battalion. Served as part of the NATO Response Force, requiring precision, teamwork, and readiness. Contributed to secure and efficient communication in demanding conditions.",
    bartender: "Bartender",
    bartenderDesc:
      "Worked during the UKA student festival at Samfundet in Trondheim, one of Norway's largest student festivals. Operated in a high-paced bar environment, developing strong skills in service, teamwork, and stress management under demanding conditions.",
    managerAndTreasurer: "Manager and Treasurer",
    managerAndTreasurerDesc:
      "Led an annual school revue at Thora Storm Upper Secondary School with over 150 participants. Responsible for planning, rehearsals, and execution of the production, as well as budgeting and financial management, including ticket sales and sponsorships.",
    programming: "Programming",
    unitTesting: "Unit Testing",
    controlsAndSignals: "Controls & Signals",
    rootLocus: "Root Locus",
    hardware: "Hardware",
    aboutText1:
      "Bachelor student in Automation and Intelligent Systems at NTNU, specializing in robotics, autonomy and control theory. I have experience with simulation and development of control systems, complemented by leadership experience as a shift leader in a dynamic work environment. In my free time, I am involved in student organizations and enjoy being social and engaged. I also spend time on personal projects such as building a home-lab and smart home setup, various coding projects, 3D printing and programming microcontrollers like the ESP family.",
    highlights: "Highlights",
    highlight1:
      "Hands-on with sensors (IMU, ToF, encoders) and real-time constraints.",
    highlight2: "Comfortable moving from simulation to hardware bring-up.",
    highlight3: "Curious, reliable, and safety-minded.",
    letsStartSomething: "Let's start something great",
    contactDesc:
      "Email me directly or use the form. I'm open to internships, projects, and collaborations.",
    name: "Name",
    email: "Email",
    message: "Message",
    formNote: "This form opens your email app with a prefilled message.",
    send: "Send",
    login: "Login",
    logout: "Logout",
    admin: "Admin",
    dashboard: "Dashboard",
    loginTitle: "Admin login",
    loginSubtitle: "Log in to dashboard",
    emailLabel: "Email address",
    passwordLabel: "Password",
    loginButton: "Log in",
    errorMessage: "Invalid email or password",
    notAnders: "Not Anders?",
    requestAccess: "Request access",
    backToHome: '<i class="fa-solid fa-arrow-left"></i> Back to home',
    meta: {
      description:
        "Portfolio and contact page for a student in Automation & Intelligent Systems (NTNU). Projects, experience, and ways to get in touch.",
      title: "Anders Garberg — Automation & Intelligent Systems",
    },
    placeholders: {
      name: "Your name",
      email: "you@domain.com",
      message: "Tell me about yourself",
    },
    cv: "content/CV_en.pdf",
  },
};

// Translation helper
function t(key, lang = currentLang) {
  if (translations[lang] && translations[lang][key]) {
    return translations[lang][key];
  }
  if (
    translations[lang] &&
    translations[lang].placeholders &&
    translations[lang].placeholders[key]
  ) {
    return translations[lang].placeholders[key];
  }
  if (
    translations[lang] &&
    translations[lang].meta &&
    translations[lang].meta[key]
  ) {
    return translations[lang].meta[key];
  }
  // Fallback to English
  if (lang !== "en" && translations.en && translations.en[key]) {
    console.warn(
      `Missing translation for '${key}' in '${lang}', using English.`
    );
    return translations.en[key];
  }
  // Fallback to key
  console.warn(`Missing translation for '${key}' in '${lang}', using key.`);
  return key;
}

// Language functionality with URL parameter support
function getLanguageFromURL() {
  const urlParams = new URLSearchParams(window.location.search);
  const langParam = urlParams.get("lang");

  // Check for valid language codes
  if (langParam === "en" || langParam === "no") {
    return langParam;
  }

  // Also support 'nb' for Norwegian Bokmål
  if (langParam === "nb") {
    return "no";
  }

  return null;
}

function setLanguageInURL(lang) {
  const url = new URL(window.location);
  url.searchParams.set("lang", lang);

  // Update URL without reloading the page
  window.history.replaceState({}, "", url);
}

let currentLang =
  getLanguageFromURL() || localStorage.getItem("language") || "no";

function updateLanguage(lang) {
  currentLang = lang;
  window.currentLang = lang;
  localStorage.setItem("language", lang);
  document.documentElement.lang = lang;
  setLanguageInURL(lang);

  // Update title and meta description
  document.title = t("title", lang);
  const metaDesc = document.querySelector('meta[name="description"]');
  if (metaDesc) metaDesc.content = t("description", lang);

  // Update all translatable elements
  const elements = document.querySelectorAll("[data-translate]");
  elements.forEach((element) => {
    const key = element.getAttribute("data-translate");
    element.innerHTML = t(key, lang);
  });

  // Update CV download link based on language
  const cvLink = document.querySelector('a[data-translate="downloadCV"]');
  if (cvLink) {
    cvLink.href = translations[lang].cv || translations.en.cv;
  }

  // Update placeholders
  const nameInput = document.getElementById("name");
  const emailInput = document.getElementById("email");
  const messageTextarea = document.getElementById("message");
  if (nameInput) nameInput.placeholder = t("name", lang);
  if (emailInput) emailInput.placeholder = t("email", lang);
  if (messageTextarea) messageTextarea.placeholder = t("message", lang);
}

// Theme functionality
// Theme functionality (centralized)
const root = document.documentElement;

function getThemeFromUrl() {
  const params = new URLSearchParams(window.location.search);
  const theme = params.get("theme");
  if (theme === "light" || theme === "dark") return theme;
  return null;
}

function getUserThemePref() {
  return localStorage.getItem("theme");
}

function getSystemThemePref() {
  return window.matchMedia("(prefers-color-scheme: dark)").matches
    ? "dark"
    : "light";
}

function applyTheme(mode) {
  // Set data-theme attribute for CSS
  root.setAttribute("data-theme", mode);
  if (mode === "light") {
    root.classList.add("light");
  } else {
    root.classList.remove("light");
  }
  localStorage.setItem("theme", mode);
  // Update URL parameter for sharing
  const params = new URLSearchParams(window.location.search);
  params.set("theme", mode);
  window.history.replaceState({}, "", `${window.location.pathname}?${params}`);
}

function setupThemeToggles() {
  const themeToggle = document.getElementById("themeToggle");
  const themeToggleMobile = document.getElementById("themeToggleMobile");
  function toggleTheme() {
    const current = root.getAttribute("data-theme") || getSystemThemePref();
    const next = current === "dark" ? "light" : "dark";
    applyTheme(next);
  }
  if (themeToggle) themeToggle.addEventListener("click", toggleTheme);
  if (themeToggleMobile)
    themeToggleMobile.addEventListener("click", toggleTheme);
}

// Update scroll padding based on actual header heights
function updateScrollPadding() {
  const nav = document.querySelector("nav");
  const devBanner = document.querySelector(".dev-banner");
  const navHeight = nav ? nav.offsetHeight : 64;
  const bannerHeight = devBanner ? devBanner.offsetHeight : 0;
  const totalOffset = navHeight + bannerHeight;

  document.documentElement.style.scrollPaddingTop = `${totalOffset}px`;
}

// Track current view mode (admin or public)
let viewMode = localStorage.getItem("viewMode") || "admin"; // 'admin' or 'public'

// Update admin navigation buttons visibility
function updateAdminNavButtons() {
  // Desktop nav links
  const navProjects = document.getElementById("navProjects");
  const navExperience = document.getElementById("navExperience");
  const navAbout = document.getElementById("navAbout");
  const navContact = document.getElementById("navContact");

  // Mobile nav links
  const navProjectsMobile = document.getElementById("navProjectsMobile");
  const navExperienceMobile = document.getElementById("navExperienceMobile");
  const navAboutMobile = document.getElementById("navAboutMobile");
  const navContactMobile = document.getElementById("navContactMobile");

  // Admin buttons
  const viewPublicBtn = document.getElementById("viewPublicBtn");
  const dashboardNavBtn = document.getElementById("dashboardNavBtn");
  const showQrBtn = document.getElementById("showQrBtn");

  const viewPublicBtnMobile = document.getElementById("viewPublicBtnMobile");
  const dashboardNavBtnMobile = document.getElementById(
    "dashboardNavBtnMobile"
  );
  const showQrBtnMobile = document.getElementById("showQrBtnMobile");

  if (viewMode === "admin") {
    // Hide public nav links
    if (navProjects) navProjects.style.display = "none";
    if (navExperience) navExperience.style.display = "none";
    if (navAbout) navAbout.style.display = "none";
    if (navContact) navContact.style.display = "none";

    if (navProjectsMobile) navProjectsMobile.style.display = "none";
    if (navExperienceMobile) navExperienceMobile.style.display = "none";
    if (navAboutMobile) navAboutMobile.style.display = "none";
    if (navContactMobile) navContactMobile.style.display = "none";

    // Show admin nav buttons
    if (viewPublicBtn) viewPublicBtn.style.display = "inline-block";
    if (dashboardNavBtn) dashboardNavBtn.style.display = "inline-block";
    if (showQrBtn) showQrBtn.style.display = "inline-block";

    if (viewPublicBtnMobile) viewPublicBtnMobile.style.display = "block";
    if (dashboardNavBtnMobile) dashboardNavBtnMobile.style.display = "block";
    if (showQrBtnMobile) showQrBtnMobile.style.display = "block";
  } else {
    // Show public nav links (if they exist)
    if (navProjects) navProjects.style.display = "inline-block";
    if (navExperience) navExperience.style.display = "inline-block";
    if (navAbout) navAbout.style.display = "inline-block";
    if (navContact) navContact.style.display = "inline-block";

    if (navProjectsMobile) navProjectsMobile.style.display = "block";
    if (navExperienceMobile) navExperienceMobile.style.display = "block";
    if (navAboutMobile) navAboutMobile.style.display = "block";
    if (navContactMobile) navContactMobile.style.display = "block";

    // Hide admin nav buttons
    if (viewPublicBtn) viewPublicBtn.style.display = "none";
    if (dashboardNavBtn) dashboardNavBtn.style.display = "none";
    if (showQrBtn) showQrBtn.style.display = "none";

    if (viewPublicBtnMobile) viewPublicBtnMobile.style.display = "none";
    if (dashboardNavBtnMobile) dashboardNavBtnMobile.style.display = "none";
    if (showQrBtnMobile) showQrBtnMobile.style.display = "none";
  }
}

// Toggle between admin and public view
function toggleView() {
  viewMode = viewMode === "admin" ? "public" : "admin";
  localStorage.setItem("viewMode", viewMode);
  updateViewDisplay();
  updateAdminNavButtons();
  closeUserPopup();

  // Close mobile menu if open
  const mobileMenu = document.getElementById("mobileMenu");
  const mobileOverlay = document.getElementById("mobileOverlay");
  const hamburger = document.getElementById("hamburger");

  if (mobileMenu && mobileMenu.classList.contains("active")) {
    mobileMenu.classList.remove("active");
    if (mobileOverlay) mobileOverlay.classList.remove("active");
    if (hamburger) hamburger.classList.remove("active");
    document.body.classList.remove("mobile-menu-open");
  }
}

// Update display based on view mode
function updateViewDisplay() {
  const publicContent = document.getElementById("publicContent");
  const publicSections = document.getElementById("publicSections");
  const loggedInContent = document.getElementById("loggedInContent");
  const toggleBtn = document.getElementById("toggleViewBtn");

  if (viewMode === "public") {
    // Show public view
    if (publicContent) publicContent.style.display = "grid";
    if (publicSections) publicSections.style.display = "block";
    if (loggedInContent) loggedInContent.style.display = "none";
    if (toggleBtn) toggleBtn.innerHTML = '<i class="fa-solid fa-lock"></i> View as Admin';
  } else {
    // Show admin view
    if (publicContent) publicContent.style.display = "none";
    if (publicSections) publicSections.style.display = "none";
    if (loggedInContent) loggedInContent.style.display = "block";
    if (toggleBtn) toggleBtn.innerHTML = '<i class="fa-solid fa-eye"></i> View as Public';
  }
}

// Show user popup
async function showUserPopup() {
  const popup = document.getElementById("userPopup");
  if (!popup) return;

  // Get user info
  if (window.auth) {
    const user = await window.auth.getCurrentUser();
    const userEmailEl = document.getElementById("userEmail");
    if (userEmailEl && user && user.email) {
      userEmailEl.textContent = user.email;
    }
  }

  // Update toggle button text
  updateViewDisplay();

  popup.style.display = "flex";

  // Add escape key listener
  const escapeHandler = (e) => {
    if (e.key === "Escape") {
      closeUserPopup();
      document.removeEventListener("keydown", escapeHandler);
    }
  };
  document.addEventListener("keydown", escapeHandler);

  // Close on overlay click
  popup.onclick = (e) => {
    if (e.target === popup) {
      closeUserPopup();
    }
  };
}

function closeUserPopup() {
  const popup = document.getElementById("userPopup");
  if (popup) {
    popup.style.display = "none";
  }
}

// Show QR code popup
function showQrPopup() {
  const popup = document.getElementById("qrPopup");
  if (!popup) return;

  // Generate QR code
  const qrContainer = document.getElementById("qrCodeContainer");
  if (qrContainer) {
    // Clear existing QR code
    qrContainer.innerHTML = "";

    // Create QR code using a simple library (we'll use qrcode.js via CDN)
    const qr = document.createElement("div");
    qr.id = "qrcode";
    qrContainer.appendChild(qr);

    // Generate QR code (using qrcodejs library loaded from CDN)
    if (window.QRCode) {
      new QRCode(qr, {
        text: "https://garberg.wtf",
        width: 256,
        height: 256,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H,
      });
    } else {
      qrContainer.innerHTML = "<p>Loading QR code...</p>";
    }
  }

  popup.style.display = "flex";

  // Add escape key listener
  const escapeHandler = (e) => {
    if (e.key === "Escape") {
      closeQrPopup();
      document.removeEventListener("keydown", escapeHandler);
    }
  };
  document.addEventListener("keydown", escapeHandler);

  // Close on overlay click
  popup.onclick = (e) => {
    if (e.target === popup) {
      closeQrPopup();
    }
  };
}

function closeQrPopup() {
  const popup = document.getElementById("qrPopup");
  if (popup) {
    popup.style.display = "none";
  }
}

// Check and update login status
async function updateLoginStatus() {
  console.log("Checking login status...");

  // Wait for auth module to load
  let attempts = 0;
  while (!window.auth && attempts < 100) {
    await new Promise((resolve) => setTimeout(resolve, 100));
    attempts++;
  }

  if (!window.auth) {
    console.log("Auth module not loaded");
    return;
  }

  try {
    const isLoggedIn = await window.auth.isAuthenticated();
    console.log("Is logged in:", isLoggedIn);

    if (isLoggedIn) {
      // User is logged in - respect their view mode
      updateViewDisplay();
      updateAdminNavButtons();
    } else {
      // User is logged out - always show public view
      viewMode = "public";
      localStorage.removeItem("viewMode");

      const publicContent = document.getElementById("publicContent");
      const publicSections = document.getElementById("publicSections");
      const loggedInContent = document.getElementById("loggedInContent");

      if (publicContent) publicContent.style.display = "grid";
      if (publicSections) publicSections.style.display = "block";
      if (loggedInContent) loggedInContent.style.display = "none";
    }

    // Update desktop buttons
    const loginToggle = document.getElementById("loginToggle");
    const loginBtn = document.getElementById("loginBtn");

    if (loginToggle) {
      if (isLoggedIn) {
        loginToggle.style.display = "inline-flex";
        loginToggle.innerHTML = '<i class="fa-solid fa-user"></i>';
        loginToggle.title = "View profile";
        loginToggle.style.color = "var(--brand)";

        if (loginBtn) loginBtn.style.display = "none";
      } else {
        loginToggle.style.display = "none";

        if (loginBtn) loginBtn.style.display = "inline-flex";
      }
    }

    // Update mobile buttons
    const loginToggleMobile = document.getElementById("loginToggleMobile");
    const loginBtnMobile = document.getElementById("loginBtnMobile");

    if (loginToggleMobile) {
      if (isLoggedIn) {
        loginToggleMobile.style.display = "inline-flex";
        loginToggleMobile.innerHTML = '<i class="fa-solid fa-user"></i>';
        loginToggleMobile.title = "View profile";
        loginToggleMobile.style.color = "var(--brand)";

        if (loginBtnMobile) loginBtnMobile.style.display = "none";
      } else {
        loginToggleMobile.style.display = "none";

        if (loginBtnMobile) loginBtnMobile.style.display = "block";
      }
    }

    // Setup logout button on main page
    const logoutBtnMain = document.getElementById("logoutBtnMain");
    if (logoutBtnMain && isLoggedIn) {
      logoutBtnMain.onclick = async () => {
        if (window.auth) {
          await window.auth.logout();
          localStorage.removeItem("viewMode");
          window.location.reload();
        }
      };
    }
  } catch (error) {
    console.error("Error checking login status:", error);
  }
}

// Export functions
window.showUserPopup = showUserPopup;
window.closeUserPopup = closeUserPopup;
window.toggleView = toggleView;
window.showQrPopup = showQrPopup;
window.closeQrPopup = closeQrPopup;
window.updateLanguage = updateLanguage;
window.currentLang = currentLang;

// Initialize theme and language
document.addEventListener("DOMContentLoaded", function () {
  // Theme initialization: URL param > localStorage > system
  const urlTheme = getThemeFromUrl();
  const userTheme = getUserThemePref();
  const systemTheme = getSystemThemePref();
  applyTheme(urlTheme || userTheme || systemTheme);
  setupThemeToggles();

  // Initialize language (URL parameter takes precedence)
  const urlLang = getLanguageFromURL();
  if (urlLang && urlLang !== currentLang) {
    currentLang = urlLang;
    localStorage.setItem("language", urlLang);
  }

  updateLanguage(currentLang);
  updateScrollPadding();

  // Update on resize in case banner height changes
  window.addEventListener("resize", updateScrollPadding);
  // Set year
  const yearElement = document.getElementById("year");
  if (yearElement) {
    yearElement.textContent = new Date().getFullYear();
  }

  // Wait a bit then check login status
  setTimeout(() => {
    updateLoginStatus();
  }, 500);

  // Setup popup close button
  const closeBtn = document.getElementById("closeUserPopup");
  if (closeBtn) {
    closeBtn.addEventListener("click", closeUserPopup);
  }

  // Setup popup logout button
  const logoutBtnPopup = document.getElementById("logoutBtnPopup");
  if (logoutBtnPopup) {
    logoutBtnPopup.addEventListener("click", async () => {
      if (window.auth) {
        await window.auth.logout();
        closeUserPopup();
        window.location.reload();
      }
    });
  }

  // Setup view toggle button
  const toggleViewBtn = document.getElementById("toggleViewBtn");
  if (toggleViewBtn) {
    toggleViewBtn.addEventListener("click", toggleView);
  }

  // Setup QR popup close button
  const closeQrBtn = document.getElementById("closeQrPopup");
  if (closeQrBtn) {
    closeQrBtn.addEventListener("click", closeQrPopup);
  }

  // Setup view public button (desktop)
  const viewPublicBtn = document.getElementById("viewPublicBtn");
  if (viewPublicBtn) {
    viewPublicBtn.addEventListener("click", toggleView);
  }

  // Setup view public button (mobile)
  const viewPublicBtnMobile = document.getElementById("viewPublicBtnMobile");
  if (viewPublicBtnMobile) {
    viewPublicBtnMobile.addEventListener("click", toggleView);
  }

  // Setup QR button (desktop)
  const showQrBtn = document.getElementById("showQrBtn");
  if (showQrBtn) {
    showQrBtn.addEventListener("click", showQrPopup);
  }

  // Setup QR button (mobile)
  const showQrBtnMobile = document.getElementById("showQrBtnMobile");
  if (showQrBtnMobile) {
    showQrBtnMobile.addEventListener("click", showQrPopup);
  }
});
