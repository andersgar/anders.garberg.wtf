// Translations object
const translations = {
  no: {
    devBanner: "ðŸš§ Denne nettsiden er under utvikling",
    skipToContent: "Hopp til innhold",
    projects: "Prosjekter",
    experience: "Erfaring",
    skills: "Ferdigheter",
    about: "Om meg",
    contact: "Kontakt",
    degreeProgram: "Automatisering og intelligente systemer @ NTNU Â· Trondheim",
    greeting: "Hei, jeg er",
    heroSubtitle:
      "Bachelorstudent i Automatisering og intelligente systemer pÃ¥ NTNU, spesialiserer meg innen robotikk, autonomi og reguleringsteknikk. Erfaren med simulering og utvikling av styringssystemer, supplert med ledererfaring som skiftleder i et dynamisk arbeidsmiljÃ¸.",
    seeProjects: "Se prosjekter",
    getInTouch: "Ta kontakt",
    controlSystems: "Styringssystemer",
    modeling: "Modellering",
    physics: "Fysikk",
    openToInternships: "Ã…pen for praksis Â· 2026",
    heroDescription:
      "Nysgjerrig automatiseringsstudent med lidenskap for autonomi, navigasjon og styring. SÃ¸ker sommerpraksis hvor jeg kan bidra til utvikling av robuste, intelligente systemer og lÃ¦re av virkelige ingeniÃ¸rutfordringer underveis.",
    downloadCV: "Last ned CV",
    emailMe: "Send e-post",
    featuredProjects: "Utvalgte prosjekter",
    projectsSubtitle: "Noen ting jeg har jobbet med nylig.",
    Lorem: "Lorem",
    "Lorem, ipsum.": "Lorem, ipsum.",
    "Lorem ipsum dolor sit amet.": "Lorem ipsum dolor sit amet.",
    repo: "Repo",
    financialManager: "Ã˜konomiansvarlig",
    voluntaryWork: "Frivillig arbeid",
    present: "NÃ¥vÃ¦rende",
    financialManagerDesc:
      "Hadde ansvaret for budsjettering, regnskap og finansiell planlegging for studentorganisasjonen som representerer elektrostudenter pÃ¥ NTNU. Introduserte strukturerte finansielle prosedyrer som forbedret transparens, nÃ¸yaktighet og kontroll av organisasjonens finansielle drift.",
    shiftLeader: "Skiftleder",
    partTime: "Deltid",
    shiftLeaderDesc:
      "Ansvarlig for opplÃ¦ring, drift og kundeservice i et tempofylt miljÃ¸. Bidro til forbedrede prosedyrer som Ã¸kte effektiviteten i billett- og kiosksalg samtidig som den totale kundeopplevelsen ble forbedret.",
    teachingAssistant: "Undervisningsassistent",
    teachingAssistantDesc:
      "StÃ¸tter undervisning og studentveiledning pÃ¥ NTNU. Gir akademisk assistanse, hjelper med Ã¸vinger og legger til rette for dypere forstÃ¥else av fagstoffet.",
    communicationsOperator: "SambandsoperatÃ¸r - Luftvern",
    fullTime: "Fulltid",
    norwegianArmedForces: "Forsvaret",
    communicationsOperatorDesc:
      "Operativ erfaring med sambandssystemer i Luftvernbataljonen. Tjenestegjorde som del av NATO Response Force, som krevde presisjon, lagarbeid og beredskap. Bidro til sikker og effektiv kommunikasjon under krevende forhold.",
    bartender: "Bartender",
    bartenderDesc:
      "Jobbet under UKA-studentfestivalen pÃ¥ Samfundet i Trondheim, en av Norges stÃ¸rste studentfestivaler. Opererte i et hÃ¸ytempobart miljÃ¸ og utviklet sterke ferdigheter innen service, lagarbeid og stresshÃ¥ndtering under krevende forhold.",
    managerAndTreasurer: "Leder og kasserer",
    managerAndTreasurerDesc:
      "Ledet en Ã¥rlig skolerevy pÃ¥ Thora Storm videregÃ¥ende skole med over 150 deltakere. Ansvarlig for planlegging, Ã¸vinger og gjennomfÃ¸ring av produksjonen, samt budsjettering og Ã¸konomistyring, inkludert billettsalg og sponsorater.",
    programming: "Programmering",
    unitTesting: "Enhetstesting",
    controlsAndSignals: "Styring og signaler",
    rootLocus: "Rotlokus",
    hardware: "Maskinvare",
    aboutText1:
      "Jeg er student i Automatisering og intelligente systemer pÃ¥ NTNU, basert i Trondheim, Norge. Mine interesser ligger i skjÃ¦ringspunktet mellom reguleringsteknikk og innebygd programvare â€” Ã¥ bruke streng matematikk for Ã¥ fÃ¥ maskinvare til Ã¥ oppfÃ¸re seg.",
    aboutText2:
      "NÃ¥r jeg ikke studerer, finner du meg ved Ã¥ bygge smÃ¥ roboter, lese databladene eller gÃ¥ tur rundt Bymarka.",
    highlights: "HÃ¸ydepunkter",
    highlight1:
      "Hands-on med sensorer (IMU, ToF, encodere) og sanntidsbegrensninger.",
    highlight2: "Komfortabel med Ã¥ gÃ¥ fra simulering til maskinvareoppstart.",
    highlight3: "Nysgjerrig, pÃ¥litelig og sikkerhetsorientert.",
    letsStartSomething: "La oss starte noe flott",
    contactDesc:
      "Send meg en e-post direkte eller bruk skjemaet. Jeg er Ã¥pen for praksis, prosjekter og samarbeid.",
    name: "Navn",
    email: "E-post",
    message: "Melding",
    formNote:
      "Dette skjemaet Ã¥pner e-postappen din med en forhÃ¥ndsutfylt melding.",
    send: "Send",
    login: "Logg inn",
    logout: "Logg ut",
    admin: "Admin",
    dashboard: "Dashboard",
  },
  en: {
    devBanner: "ðŸš§ This website is under development",
    skipToContent: "Skip to content",
    projects: "Projects",
    experience: "Experience",
    skills: "Skills",
    about: "About",
    contact: "Contact",
    degreeProgram: "Automation & Intelligent Systems @ NTNU Â· Trondheim",
    greeting: "Hi, I'm",
    heroSubtitle:
      "Bachelor's student in Automation and Intelligent Systems at NTNU, specializing in robotics, autonomy, and control engineering. Skilled in simulation and control system development, complemented by leadership experience as a shift supervisor in a dynamic work environment.",
    seeProjects: "See projects",
    getInTouch: "Get in touch",
    controlSystems: "Control systems",
    modeling: "Modeling",
    physics: "Physics",
    openToInternships: "Open to Internships Â· 2026",
    heroDescription:
      "Curious automation student passionate about autonomy, navigation, and control. Looking for a summer internship where I can contribute to developing resilient, intelligent systems, and learn from real engineering challenges along the way.",
    downloadCV: "Download CV",
    emailMe: "Email me",
    featuredProjects: "Featured Projects",
    projectsSubtitle: "A few things I've done recently.",
    Lorem: "Lorem",
    "Lorem, ipsum.": "Lorem, ipsum.",
    "Lorem ipsum dolor sit amet.": "Lorem ipsum dolor sit amet.",
    repo: "Repo",
    financialManager: "Financial Manager",
    voluntaryWork: "Voluntary work",
    present: "Present",
    financialManagerDesc:
      "Oversaw the budgeting, accounting, and financial planning processes for the student organization representing electrical engineering students at NTNU. Introduced structured financial management procedures that enhanced transparency, accuracy, and control of the organization's financial operations.",
    shiftLeader: "Shift Leader",
    partTime: "Part-time",
    shiftLeaderDesc:
      "Responsible for training, operations, and customer service in a fast-paced environment. Contributed to improved procedures that increased efficiency in ticketing and concession operations while enhancing the overall customer experience.",
    teachingAssistant: "Teaching Assistant",
    teachingAssistantDesc:
      "Supports teaching and student guidance at NTNU. Provides academic assistance, helps with exercises, and facilitates deeper understanding of the course material.",
    communicationsOperator: "Communications Operator - Air Defence",
    fullTime: "Full-time",
    norwegianArmedForces: "Norwegian Armed Forces",
    communicationsOperatorDesc:
      "Operational experience with communication systems in the Air Defence Battalion. Served as part of the NATO Response Force, requiring precision, teamwork, and readiness. Contributed to secure and efficient communication in demanding conditions.",
    bartender: "Bartender",
    bartenderDesc:
      "Worked during the UKA student festival at Samfundet in Trondheim, one of Norway's largest student festivals. Operated in a high-paced bar environment, developing strong skills in service, teamwork, and stress management under demanding conditions.",
    managerAndTreasurer: "Manager and Treasurer",
    managerAndTreasurerDesc:
      "Led an annual school revue at Thora Storm Upper Secondary School with over 150 participants. Responsible for planning, rehearsals, and execution of the production, as well as budgeting and financial management, including ticket sales and sponsorships.",
    programming: "Programming",
    unitTesting: "Unit Testing",
    controlsAndSignals: "Controls & Signals",
    rootLocus: "Root Locus",
    hardware: "Hardware",
    aboutText1:
      "I'm a student in Automation & Intelligent Systems at NTNU, based in Trondheim, Norway. My interests sit at the intersection of control engineering and embedded software â€” using rigorous math to make hardware behave.",
    aboutText2:
      "When I'm not studying, you'll find me building small robots, reading datasheets, or hiking around Bymarka.",
    highlights: "Highlights",
    highlight1:
      "Hands-on with sensors (IMU, ToF, encoders) and real-time constraints.",
    highlight2: "Comfortable moving from simulation to hardware bring-up.",
    highlight3: "Curious, reliable, and safety-minded.",
    letsStartSomething: "Let's start something great",
    contactDesc:
      "Email me directly or use the form. I'm open to internships, projects, and collaborations.",
    name: "Name",
    email: "Email",
    message: "Message",
    formNote: "This form opens your email app with a prefilled message.",
    send: "Send",
    login: "Login",
    logout: "Logout",
    admin: "Admin",
    dashboard: "Dashboard",
  },
};

// Language functionality with URL parameter support
function getLanguageFromURL() {
  const urlParams = new URLSearchParams(window.location.search);
  const langParam = urlParams.get("lang");

  // Check for valid language codes
  if (langParam === "en" || langParam === "no") {
    return langParam;
  }

  // Also support 'nb' for Norwegian BokmÃ¥l
  if (langParam === "nb") {
    return "no";
  }

  return null;
}

function setLanguageInURL(lang) {
  const url = new URL(window.location);
  url.searchParams.set("lang", lang);

  // Update URL without reloading the page
  window.history.replaceState({}, "", url);
}

let currentLang =
  getLanguageFromURL() || localStorage.getItem("language") || "no";

function updateLanguage(lang) {
  currentLang = lang;
  localStorage.setItem("language", lang);
  document.documentElement.lang = lang;

  // Update URL parameter
  setLanguageInURL(lang);

  // Update title and meta description
  if (lang === "no") {
    document.title = "Anders Garberg â€” Automatisering og intelligente systemer";
    document.querySelector('meta[name="description"]').content =
      "Portfolio og kontaktside for student i Automatisering og intelligente systemer (NTNU). Prosjekter, erfaring og mÃ¥ter Ã¥ ta kontakt pÃ¥.";
  } else {
    document.title = "Anders Garberg â€” Automation & Intelligent Systems";
    document.querySelector('meta[name="description"]').content =
      "Portfolio and contact page for a student in Automation & Intelligent Systems (NTNU). Projects, experience, and ways to get in touch.";
  }

  // Update all translatable elements
  const elements = document.querySelectorAll("[data-translate]");
  elements.forEach((element) => {
    const key = element.getAttribute("data-translate");
    if (translations[lang] && translations[lang][key]) {
      element.textContent = translations[lang][key];
    }
  });

  // Update CV download link based on language
  const cvLink = document.querySelector('a[data-translate="downloadCV"]');
  if (cvLink) {
    if (lang === "no") {
      cvLink.href = "content/CV_no.pdf";
    } else {
      cvLink.href = "content/CV_en.pdf";
    }
  }

  // Update placeholders
  const nameInput = document.getElementById("name");
  const emailInput = document.getElementById("email");
  const messageTextarea = document.getElementById("message");

  if (nameInput && emailInput && messageTextarea) {
    if (lang === "no") {
      nameInput.placeholder = "Ditt navn";
      emailInput.placeholder = "deg@domene.no";
      messageTextarea.placeholder = "Fortell meg om deg selv";
    } else {
      nameInput.placeholder = "Your name";
      emailInput.placeholder = "you@domain.com";
      messageTextarea.placeholder = "Tell me about yourself";
    }
  }
}

// Theme functionality
// Theme functionality (centralized)
const root = document.documentElement;

function getThemeFromUrl() {
  const params = new URLSearchParams(window.location.search);
  const theme = params.get("theme");
  if (theme === "light" || theme === "dark") return theme;
  return null;
}

function getUserThemePref() {
  return localStorage.getItem("theme");
}

function getSystemThemePref() {
  return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
}

function applyTheme(mode) {
  // Set data-theme attribute for CSS
  root.setAttribute("data-theme", mode);
  if (mode === "light") {
    root.classList.add("light");
  } else {
    root.classList.remove("light");
  }
  localStorage.setItem("theme", mode);
  // Update URL parameter for sharing
  const params = new URLSearchParams(window.location.search);
  params.set("theme", mode);
  window.history.replaceState({}, "", `${window.location.pathname}?${params}`);
}

function setupThemeToggles() {
  const themeToggle = document.getElementById("themeToggle");
  const themeToggleMobile = document.getElementById("themeToggleMobile");
  function toggleTheme() {
    const current = root.getAttribute("data-theme") || getSystemThemePref();
    const next = current === "dark" ? "light" : "dark";
    applyTheme(next);
  }
  if (themeToggle) themeToggle.addEventListener("click", toggleTheme);
  if (themeToggleMobile) themeToggleMobile.addEventListener("click", toggleTheme);
}

// Update scroll padding based on actual header heights
function updateScrollPadding() {
  const nav = document.querySelector("nav");
  const devBanner = document.querySelector(".dev-banner");
  const navHeight = nav ? nav.offsetHeight : 64;
  const bannerHeight = devBanner ? devBanner.offsetHeight : 0;
  const totalOffset = navHeight + bannerHeight;

  document.documentElement.style.scrollPaddingTop = `${totalOffset}px`;
}

// Track current view mode (admin or public)
let viewMode = localStorage.getItem("viewMode") || "admin"; // 'admin' or 'public'

// Update admin navigation buttons visibility
function updateAdminNavButtons() {
  // Desktop nav links
  const navProjects = document.getElementById("navProjects");
  const navExperience = document.getElementById("navExperience");
  const navAbout = document.getElementById("navAbout");
  const navContact = document.getElementById("navContact");

  // Mobile nav links
  const navProjectsMobile = document.getElementById("navProjectsMobile");
  const navExperienceMobile = document.getElementById("navExperienceMobile");
  const navAboutMobile = document.getElementById("navAboutMobile");
  const navContactMobile = document.getElementById("navContactMobile");

  // Admin buttons
  const viewPublicBtn = document.getElementById("viewPublicBtn");
  const dashboardNavBtn = document.getElementById("dashboardNavBtn");
  const showQrBtn = document.getElementById("showQrBtn");

  const viewPublicBtnMobile = document.getElementById("viewPublicBtnMobile");
  const dashboardNavBtnMobile = document.getElementById(
    "dashboardNavBtnMobile"
  );
  const showQrBtnMobile = document.getElementById("showQrBtnMobile");

  if (viewMode === "admin") {
    // Hide public nav links
    if (navProjects) navProjects.style.display = "none";
    if (navExperience) navExperience.style.display = "none";
    if (navAbout) navAbout.style.display = "none";
    if (navContact) navContact.style.display = "none";

    if (navProjectsMobile) navProjectsMobile.style.display = "none";
    if (navExperienceMobile) navExperienceMobile.style.display = "none";
    if (navAboutMobile) navAboutMobile.style.display = "none";
    if (navContactMobile) navContactMobile.style.display = "none";

    // Show admin nav buttons
    if (viewPublicBtn) viewPublicBtn.style.display = "inline-block";
    if (dashboardNavBtn) dashboardNavBtn.style.display = "inline-block";
    if (showQrBtn) showQrBtn.style.display = "inline-block";

    if (viewPublicBtnMobile) viewPublicBtnMobile.style.display = "block";
    if (dashboardNavBtnMobile) dashboardNavBtnMobile.style.display = "block";
    if (showQrBtnMobile) showQrBtnMobile.style.display = "block";
  } else {
    // Show public nav links (if they exist)
    if (navProjects) navProjects.style.display = "inline-block";
    if (navExperience) navExperience.style.display = "inline-block";
    if (navAbout) navAbout.style.display = "inline-block";
    if (navContact) navContact.style.display = "inline-block";

    if (navProjectsMobile) navProjectsMobile.style.display = "block";
    if (navExperienceMobile) navExperienceMobile.style.display = "block";
    if (navAboutMobile) navAboutMobile.style.display = "block";
    if (navContactMobile) navContactMobile.style.display = "block";

    // Hide admin nav buttons
    if (viewPublicBtn) viewPublicBtn.style.display = "none";
    if (dashboardNavBtn) dashboardNavBtn.style.display = "none";
    if (showQrBtn) showQrBtn.style.display = "none";

    if (viewPublicBtnMobile) viewPublicBtnMobile.style.display = "none";
    if (dashboardNavBtnMobile) dashboardNavBtnMobile.style.display = "none";
    if (showQrBtnMobile) showQrBtnMobile.style.display = "none";
  }
}

// Toggle between admin and public view
function toggleView() {
  viewMode = viewMode === "admin" ? "public" : "admin";
  localStorage.setItem("viewMode", viewMode);
  updateViewDisplay();
  updateAdminNavButtons();
  closeUserPopup();

  // Close mobile menu if open
  const mobileMenu = document.getElementById("mobileMenu");
  const mobileOverlay = document.getElementById("mobileOverlay");
  const hamburger = document.getElementById("hamburger");

  if (mobileMenu && mobileMenu.classList.contains("active")) {
    mobileMenu.classList.remove("active");
    if (mobileOverlay) mobileOverlay.classList.remove("active");
    if (hamburger) hamburger.classList.remove("active");
    document.body.classList.remove("mobile-menu-open");
  }
}

// Update display based on view mode
function updateViewDisplay() {
  const publicContent = document.getElementById("publicContent");
  const publicSections = document.getElementById("publicSections");
  const loggedInContent = document.getElementById("loggedInContent");
  const toggleBtn = document.getElementById("toggleViewBtn");

  if (viewMode === "public") {
    // Show public view
    if (publicContent) publicContent.style.display = "grid";
    if (publicSections) publicSections.style.display = "block";
    if (loggedInContent) loggedInContent.style.display = "none";
    if (toggleBtn) toggleBtn.innerHTML = "ðŸ” View as Admin";
  } else {
    // Show admin view
    if (publicContent) publicContent.style.display = "none";
    if (publicSections) publicSections.style.display = "none";
    if (loggedInContent) loggedInContent.style.display = "block";
    if (toggleBtn) toggleBtn.innerHTML = "ðŸ‘ï¸ View as Public";
  }
}

// Show user popup
async function showUserPopup() {
  const popup = document.getElementById("userPopup");
  if (!popup) return;

  // Get user info
  if (window.auth) {
    const user = await window.auth.getCurrentUser();
    const userEmailEl = document.getElementById("userEmail");
    if (userEmailEl && user && user.email) {
      userEmailEl.textContent = user.email;
    }
  }

  // Update toggle button text
  updateViewDisplay();

  popup.style.display = "flex";

  // Add escape key listener
  const escapeHandler = (e) => {
    if (e.key === "Escape") {
      closeUserPopup();
      document.removeEventListener("keydown", escapeHandler);
    }
  };
  document.addEventListener("keydown", escapeHandler);

  // Close on overlay click
  popup.onclick = (e) => {
    if (e.target === popup) {
      closeUserPopup();
    }
  };
}

function closeUserPopup() {
  const popup = document.getElementById("userPopup");
  if (popup) {
    popup.style.display = "none";
  }
}

// Show QR code popup
function showQrPopup() {
  const popup = document.getElementById("qrPopup");
  if (!popup) return;

  // Generate QR code
  const qrContainer = document.getElementById("qrCodeContainer");
  if (qrContainer) {
    // Clear existing QR code
    qrContainer.innerHTML = "";

    // Create QR code using a simple library (we'll use qrcode.js via CDN)
    const qr = document.createElement("div");
    qr.id = "qrcode";
    qrContainer.appendChild(qr);

    // Generate QR code (using qrcodejs library loaded from CDN)
    if (window.QRCode) {
      new QRCode(qr, {
        text: "https://garberg.wtf",
        width: 256,
        height: 256,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H,
      });
    } else {
      qrContainer.innerHTML = "<p>Loading QR code...</p>";
    }
  }

  popup.style.display = "flex";

  // Add escape key listener
  const escapeHandler = (e) => {
    if (e.key === "Escape") {
      closeQrPopup();
      document.removeEventListener("keydown", escapeHandler);
    }
  };
  document.addEventListener("keydown", escapeHandler);

  // Close on overlay click
  popup.onclick = (e) => {
    if (e.target === popup) {
      closeQrPopup();
    }
  };
}

function closeQrPopup() {
  const popup = document.getElementById("qrPopup");
  if (popup) {
    popup.style.display = "none";
  }
}

// Check and update login status
async function updateLoginStatus() {
  console.log("Checking login status...");

  // Wait for auth module to load
  let attempts = 0;
  while (!window.auth && attempts < 100) {
    await new Promise((resolve) => setTimeout(resolve, 100));
    attempts++;
  }

  if (!window.auth) {
    console.log("Auth module not loaded");
    return;
  }

  try {
    const isLoggedIn = await window.auth.isAuthenticated();
    console.log("Is logged in:", isLoggedIn);

    if (isLoggedIn) {
      // User is logged in - respect their view mode
      updateViewDisplay();
      updateAdminNavButtons();
    } else {
      // User is logged out - always show public view
      viewMode = "public";
      localStorage.removeItem("viewMode");

      const publicContent = document.getElementById("publicContent");
      const publicSections = document.getElementById("publicSections");
      const loggedInContent = document.getElementById("loggedInContent");

      if (publicContent) publicContent.style.display = "grid";
      if (publicSections) publicSections.style.display = "block";
      if (loggedInContent) loggedInContent.style.display = "none";
    }

    // Update desktop buttons
    const loginToggle = document.getElementById("loginToggle");
    const loginBtn = document.getElementById("loginBtn");

    if (loginToggle) {
      if (isLoggedIn) {
        loginToggle.style.display = "inline-flex";
        loginToggle.textContent = "ðŸ‘¤";
        loginToggle.title = "View profile";
        loginToggle.style.color = "var(--brand)";

        if (loginBtn) loginBtn.style.display = "none";
      } else {
        loginToggle.style.display = "none";

        if (loginBtn) loginBtn.style.display = "inline-flex";
      }
    }

    // Update mobile buttons
    const loginToggleMobile = document.getElementById("loginToggleMobile");
    const loginBtnMobile = document.getElementById("loginBtnMobile");

    if (loginToggleMobile) {
      if (isLoggedIn) {
        loginToggleMobile.style.display = "inline-flex";
        loginToggleMobile.textContent = "ðŸ‘¤";
        loginToggleMobile.title = "View profile";
        loginToggleMobile.style.color = "var(--brand)";

        if (loginBtnMobile) loginBtnMobile.style.display = "none";
      } else {
        loginToggleMobile.style.display = "none";

        if (loginBtnMobile) loginBtnMobile.style.display = "block";
      }
    }

    // Setup logout button on main page
    const logoutBtnMain = document.getElementById("logoutBtnMain");
    if (logoutBtnMain && isLoggedIn) {
      logoutBtnMain.onclick = async () => {
        if (window.auth) {
          await window.auth.logout();
          localStorage.removeItem("viewMode");
          window.location.reload();
        }
      };
    }
  } catch (error) {
    console.error("Error checking login status:", error);
  }
}

// Export functions
window.showUserPopup = showUserPopup;
window.closeUserPopup = closeUserPopup;
window.toggleView = toggleView;
window.showQrPopup = showQrPopup;
window.closeQrPopup = closeQrPopup;

// Initialize theme and language
document.addEventListener("DOMContentLoaded", function () {
  // Theme initialization: URL param > localStorage > system
  const urlTheme = getThemeFromUrl();
  const userTheme = getUserThemePref();
  const systemTheme = getSystemThemePref();
  applyTheme(urlTheme || userTheme || systemTheme);
  setupThemeToggles();

  // Initialize language (URL parameter takes precedence)
  const urlLang = getLanguageFromURL();
  if (urlLang && urlLang !== currentLang) {
    currentLang = urlLang;
    localStorage.setItem("language", urlLang);
  }

  updateLanguage(currentLang);
  updateScrollPadding();

  // Update on resize in case banner height changes
  window.addEventListener("resize", updateScrollPadding);
// ...existing code...
  // Set year
  const yearElement = document.getElementById("year");
  if (yearElement) {
    yearElement.textContent = new Date().getFullYear();
  }

  // Wait a bit then check login status
  setTimeout(() => {
    updateLoginStatus();
  }, 500);

  // Setup popup close button
  const closeBtn = document.getElementById("closeUserPopup");
  if (closeBtn) {
    closeBtn.addEventListener("click", closeUserPopup);
  }

  // Setup popup logout button
  const logoutBtnPopup = document.getElementById("logoutBtnPopup");
  if (logoutBtnPopup) {
    logoutBtnPopup.addEventListener("click", async () => {
      if (window.auth) {
        await window.auth.logout();
        closeUserPopup();
        window.location.reload();
      }
    });
  }

  // Setup view toggle button
  const toggleViewBtn = document.getElementById("toggleViewBtn");
  if (toggleViewBtn) {
    toggleViewBtn.addEventListener("click", toggleView);
  }

  // Setup QR popup close button
  const closeQrBtn = document.getElementById("closeQrPopup");
  if (closeQrBtn) {
    closeQrBtn.addEventListener("click", closeQrPopup);
  }

  // Setup view public button (desktop)
  const viewPublicBtn = document.getElementById("viewPublicBtn");
  if (viewPublicBtn) {
    viewPublicBtn.addEventListener("click", toggleView);
  }

  // Setup view public button (mobile)
  const viewPublicBtnMobile = document.getElementById("viewPublicBtnMobile");
  if (viewPublicBtnMobile) {
    viewPublicBtnMobile.addEventListener("click", toggleView);
  }

  // Setup QR button (desktop)
  const showQrBtn = document.getElementById("showQrBtn");
  if (showQrBtn) {
    showQrBtn.addEventListener("click", showQrPopup);
  }

  // Setup QR button (mobile)
  const showQrBtnMobile = document.getElementById("showQrBtnMobile");
  if (showQrBtnMobile) {
    showQrBtnMobile.addEventListener("click", showQrPopup);
  }
});
